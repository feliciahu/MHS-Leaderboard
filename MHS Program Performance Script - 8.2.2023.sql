
CREATE OR REPLACE TEMPORARY TABLE ACCT AS

SELECT	ACCT_ID AS CUST_ACCT_ID, DIM_CUST_ACCT_CURR.CUST_ACCT_NAM AS CUST_ACCT_NAME, DEA_NUM, REP_ID, REP_NAME, REP_TITLE
FROM	DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_FILTER_DATA
LEFT JOIN PRD_PSAS_DB.RPT.DIM_CUST_ACCT_CURR
ON		LTRIM(DIM_CUST_ACCT_CURR.CUST_ACCT_ID,'0') = LTRIM(V_PE_FILTER_DATA.ACCT_ID,0)
WHERE	PERIOD = '2024-04 JUL' -- USE LAST COMPLETED MONTH | FORMAT IS FY (2024) - FYMONTH (04) & CALENDAR MONTH (JULY)
AND		REP_ROLE_ID LIKE '%MHS%' -- SEGMENT
GROUP BY ACCT_ID, DIM_CUST_ACCT_CURR.CUST_ACCT_NAM, DEA_NUM, REP_ID, REP_NAME, REP_TITLE;


SELECT  CAL_YR_PERIOD AS YR_MONTH,
        COPA.CUST_NUM AS CUST_ACCT_ID,
        CUST.CUST_ACCT_NAM AS CUST_ACCT_NAME, 
        CUST.DEA_NUM, 
        REP_ID, 
        REP_NAME, 
        REP_TITLE,
        CASE WHEN ITEM.RXDA_CD = 'X' THEN 'Y' ELSE 'N' END CTRL_SUB_FLG,
        CASE WHEN POST_DT BETWEEN '2022-04-01' AND '2022-06-30' THEN 'Y'
             WHEN POST_DT BETWEEN '2023-04-01' AND '2023-06-30' THEN 'Y'
             ELSE 'N' END AS FYTD_FLG,
        CASE WHEN POST_DT BETWEEN '2022-04-01' AND '2023-03-31' THEN 'FY23'
             WHEN POST_DT >= '2023-04-01' THEN 'FY24' END AS FISCAL_YEAR,             
        SUM(SLS_QTY) AS "SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "BX_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "GX_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "SX_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "BIO_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "OTC_SLS_QTY",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN SLS_QTY ELSE 0 END) AS "MPB_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'OneStop' AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN SLS_QTY ELSE 0 END) AS "OS_SLS_QTY",
        SUM(CASE WHEN CNTRCT_LEAD_ID IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN SLS_QTY ELSE 0 END) AS "AGP_SLS_QTY",
        SUM(CASE WHEN (SLS_CTGRY_FPA_PRG_NAM = 'Multisource' OR SLS_CTGRY_FPA_PRG_NAM = 'Network Net' OR SLS_CTGRY_FPA_PRG_NAM = 'NextStop') AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129')  THEN SLS_QTY ELSE 0 END) AS "MS_NWN_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'Vendor Contract' AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN SLS_QTY ELSE 0 END) AS "VENDOR_CONTRACT_SLS_QTY",
        SUM(CASE WHEN (SLS_CTGRY_FPA_PRG_NAM IS NULL OR SLS_CTGRY_FPA_PRG_NAM = 'Bx' OR SLS_CTGRY_FPA_PRG_NAM = 'Bio' OR SLS_CTGRY_FPA_PRG_NAM = 'Sx' OR SLS_CTGRY_FPA_PRG_NAM = 'Nonsource') AND CNTRCT_LEAD_ID NOT IN 
 ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129')  THEN SLS_QTY ELSE 0 END) AS "OTHER_SLS_QTY",
        SUM(GROSS_SLS + RTRN) AS "NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "BX_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "GX_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "SX_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "BIO_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "OTC_NET_SLS",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "MPB_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'OneStop' AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "OS_NET_SLS",
        SUM(CASE WHEN CNTRCT_LEAD_ID IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "AGP_NET_SLS",
        SUM(CASE WHEN (SLS_CTGRY_FPA_PRG_NAM = 'Multisource' OR SLS_CTGRY_FPA_PRG_NAM = 'Network Net' OR SLS_CTGRY_FPA_PRG_NAM = 'NextStop') AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129')  THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "MS_NWN_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'Vendor Contract' AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "VENDOR_CONTRACT_NET_SLS",
        SUM(CASE WHEN (SLS_CTGRY_FPA_PRG_NAM IS NULL OR SLS_CTGRY_FPA_PRG_NAM = 'Bx' OR SLS_CTGRY_FPA_PRG_NAM = 'Bio' OR SLS_CTGRY_FPA_PRG_NAM = 'Sx' OR SLS_CTGRY_FPA_PRG_NAM = 'Nonsource') AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129')  THEN (GROSS_SLS + RTRN) ELSE 0 END) AS "OTHER_NET_SLS",
        SUM(GROSS_PROFIT) AS "GROSS_PROFIT",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "BX_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "GX_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "SX_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "BIO_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "OTC_GP",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN GROSS_PROFIT ELSE 0 END) AS "MPB_GP",

        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'OneStop' AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129')  THEN GROSS_PROFIT ELSE 0 END) AS "OS_GP",
        SUM(CASE WHEN CNTRCT_LEAD_ID IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN GROSS_PROFIT ELSE 0 END) AS "AGP_GP",
        SUM(CASE WHEN (SLS_CTGRY_FPA_PRG_NAM = 'Multisource' OR SLS_CTGRY_FPA_PRG_NAM = 'Network Net' OR SLS_CTGRY_FPA_PRG_NAM = 'NextStop') AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129')  THEN GROSS_PROFIT ELSE 0 END) AS "MS_NWN_GP",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'Vendor Contract' AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129') THEN GROSS_PROFIT ELSE 0 END) AS "VENDOR_CONTRACT_GP",
        SUM(CASE WHEN (SLS_CTGRY_FPA_PRG_NAM IS NULL OR SLS_CTGRY_FPA_PRG_NAM = 'Bx' OR SLS_CTGRY_FPA_PRG_NAM = 'Bio' OR SLS_CTGRY_FPA_PRG_NAM = 'Sx' OR SLS_CTGRY_FPA_PRG_NAM = 'Nonsource') AND CNTRCT_LEAD_ID NOT IN ('0000040019','0000125712','0000452279','0000526528','0000819489','0000081129')  THEN GROSS_PROFIT ELSE 0 END) AS "OTHER_GP"
        
FROM        "SBX_PSAS_DB"."SBX_EA_ALL"."V_COPA_EA" COPA
LEFT JOIN   PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR CUST
ON          LTRIM(CUST.CUST_ACCT_ID,'0') = LTRIM(COPA.CUST_NUM,'0')
LEFT JOIN   ACCT 
ON          LTRIM(ACCT.CUST_ACCT_ID,'0') = LTRIM(COPA.CUST_NUM,'0')
LEFT JOIN   PRD_PSAS_DB.RPT.T_IW_EM_ITEM ITEM
ON          COPA.MTRL_NUM = ITEM.EM_ITEM_NUM
WHERE       CMPNY_CD IN ('8000','8545','7503') -- PSAS & MPB & CFAAS
AND         POST_DT BETWEEN '2022-04-01' AND '2023-07-31'
AND         FPA_CUST_SEG_DESC = 'MHS'
GROUP BY CAL_YR_PERIOD,
        COPA.CUST_NUM,
        CUST.CUST_ACCT_NAM, 
        CUST.DEA_NUM, 
        REP_ID, 
        REP_NAME, 
        REP_TITLE,
        CASE WHEN ITEM.RXDA_CD = 'X' THEN 'Y' ELSE 'N' END,
        CASE WHEN POST_DT BETWEEN '2022-04-01' AND '2022-06-30' THEN 'Y'
             WHEN POST_DT BETWEEN '2023-04-01' AND '2023-06-30' THEN 'Y'
             ELSE 'N' END,
        CASE WHEN POST_DT BETWEEN '2022-04-01' AND '2023-03-31' THEN 'FY23'
             WHEN POST_DT >= '2023-04-01' THEN 'FY24' END;